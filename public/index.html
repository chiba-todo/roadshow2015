<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Sensor Data Visualization</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi?autoload={
            'modules':[{
              'name':'visualization',
              'version':'1',
              'packages':['corechart']
            }]
          }"></script>
    
    <script type="text/javascript">

		$(document).ready( function(){      // HTMLが準備できたら接続する
			connect();
		});

      	var wsUrl = 'ws://arduino-20150721.mybluemix.net/ws/sensor';
              // WebSocketオブジェクト
        var webSocket = null;
      
//      var socket;
		var temperatureData, humidityData, illuminanceData;
		var temperatureOptions, humidityOptions, illuminanceOptions;
		var temperatureChart, humidityChart, illuminanceChart;

		var temperatureArrey = [['Time', 'Planz Factory']];
		var humidityArrey = [['Time', 'Planz Factory']];
		var illuminanceArrey = [['Time', 'Planz Factory']];

		var cont = 0;
      
      // Google Gauge
//      google.load("visualization", "1", {packages:["gauge"]});
      	google.setOnLoadCallback(drawChart);

      	function drawChart() {
        // Data for temperature chart
	        temperatureData = google.visualization.arrayToDataTable([
	          ['Time', 'Planz Factory'],
	          ['', 0]
	        ]);
        
        // Data for humidity chart
	        humidityData = google.visualization.arrayToDataTable([
	          ['Time', 'Planz Factory'],
	          ['', 0]
	        ]);

        // Data for illuminance chart
	        illuminanceData = google.visualization.arrayToDataTable([
	          ['Time', 'Planz Factory'],
	          ['', 0]
	        ]);
        

        // Option for temperature chart
        // If you want to set other options, please refer to https://developers.google.com/chart/interactive/docs/gallery/gauge
	        temperatureOptions = {
	          	title: 'myTemperature',
	          	width: 800, height: 300,
	          	curveType: 'function',
	          	legend: { position: 'right' },
	          // chartArea: {width: '300'}   // グラフ横幅（ピクセル）
	          	hAxis: {gridlines:{count:'5'},
	//          		showTextEvery: 10,
	          		slantedText: true,  // 横軸の目盛テキストを斜めに表示
	          							// （データ数が多いときは文字が重ならないように自動的に間引かれる）
	          		slantedTextAngle: '30',  // 横軸の目盛テキストの角度
	      		},
				chartArea:{left:50,top:40,width:'70%',height:'50%'},
	        };
	        
	        // Option for humidity chart
	        humidityOptions = {
	          	title: 'myHumidity',
	          	width: 800, height: 300,
	          	curveType: 'function',
	          	legend: { position: 'right' },
	          	hAxis: {gridlines:{count:'5'},
	          		slantedText: true,  // 横軸の目盛テキストを斜めに表示
	          		slantedTextAngle: '30',  // 横軸の目盛テキストの角度
	      		},
				chartArea:{left:50,top:40,width:'70%',height:'50%'},
	        };

	        // Option for humidity chart
	        illuminanceOptions = {
	          	title: 'myIlluminance',
	          	width: 800, height: 300,
	          	curveType: 'function',
	          	legend: { position: 'right' },
	          	hAxis: {gridlines:{count:'5'},
	          		slantedText: true,  // 横軸の目盛テキストを斜めに表示
	          		slantedTextAngle: '30',  // 横軸の目盛テキストの角度
	      		},
				chartArea:{left:50,top:40,width:'70%',height:'50%'},
	        };
        
	        temperatureChart = new google.visualization.LineChart(document.getElementById('temperatureChart'));
	        humidityChart = new google.visualization.LineChart(document.getElementById('humidityChart'));
	        illuminanceChart = new google.visualization.LineChart(document.getElementById('illuminanceChart'));

	        temperatureChart.draw(temperatureData, temperatureOptions);
	        humidityChart.draw(humidityData, humidityOptions);
	        illuminanceChart.draw(illuminanceData, illuminanceOptions);
        };

      	function connect() {

           	if (webSocket == null) {
				// WebSocket の初期化
				webSocket = new WebSocket(wsUrl);
				// イベントハンドラの設定
				//                webSocket.onopen = onOpen;
				webSocket.onmessage = onMessage;
				webSocket.onclose = onClose;
			    webSocket.onerror = onError;
            }
        }


        function onMessage(event) {

	        var sensorData = JSON.parse(event.data);
	        // console.log(event.data);
	        // console.log(sensorData); 
	// {"Timestamp":"2015-07-24 04:46:22","Temperature":32.8,"Humidity":66.2,"Lux":437}

			// Update temperature data
	        console.log(cont); 
	        // 配列に入力データを追加
	        temperatureArrey.push([sensorData.Timestamp, sensorData.Temperature]);
	        // 配列をグラフ用オブジェクトに変換
	        temperatureData = google.visualization.arrayToDataTable(temperatureArrey);
	// console.log(temperatureArrey);
	// console.log(temperatureArrey[1][0]);       // temperatureData.setValue(cont, 0, sensorData.Timestamp);
			// グラフタイトルの編集（最新と最古のタイムスタンプを表示する）
			temperatureOptions.title = "Temperature  " +  temperatureArrey[1][0] + " - " +  temperatureArrey[ temperatureArrey.length - 1][0];
			// 横軸テキストの表示間隔は、データ数が増えても５つくらいに
			temperatureOptions.hAxis.showTextEvery = parseInt(temperatureArrey.length / 5);

			// Update temperature data
	        humidityArrey.push([sensorData.Timestamp, sensorData.Humidity]);
	        humidityData = google.visualization.arrayToDataTable(humidityArrey);
			humidityOptions.title = "Humidity  " +  humidityArrey[1][0] + " - " +  humidityArrey[humidityArrey.length - 1][0];
			humidityOptions.hAxis.showTextEvery = parseInt(humidityArrey.length / 5);

			// Update temperature data
	        illuminanceArrey.push([sensorData.Timestamp, sensorData.Lux]);
	        illuminanceData = google.visualization.arrayToDataTable(illuminanceArrey);
			illuminanceOptions.title = "Illuminance  " +  illuminanceArrey[1][0] + " - " +  illuminanceArrey[illuminanceArrey.length - 1][0];
			illuminanceOptions.hAxis.showTextEvery = parseInt(illuminanceArrey.length / 5);
          

			temperatureChart.draw(temperatureData, temperatureOptions);
			humidityChart.draw(humidityData, humidityOptions);
			illuminanceChart.draw(illuminanceData, illuminanceOptions);

          	cont++;
        }

      
        function onError(event) {
        	console.log(event.data);  
        }

        function onClose(event) {
        	console.log(event.code);  
            webSocket = null;    // 勝手に接続が切れることがあるので、自動再接続する
            connect();
        }
        
    </script>
  </head>
  <body>
    <h1>Information from Weather Monitor</h1>
    <div>
      <!-- <button onclick="connect()">Connect</button> -->
      <!-- <button onclick="disconnect()">Disconnect</button> -->
    </div>
    
    <div>
      <div id="temperatureChart" style="width: 900px; height: 200px"></div>
      <div id="humidityChart" style="width: 900px; height: 200px;"></div>
      <div id="illuminanceChart" style="width: 900px; height: 200px;"></div>
    </div>
  </body>
</html>